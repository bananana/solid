<!-- If you add another macro to this file or significatly edit an existing one, 
dont' forget to add a description of your changes to the appropriate styleguide
section (app/templates/styleguide/templating#discussion-helpers)
-->

{% from "helpers/users.html" import render_avatar %}

{% macro render_post(cause, post) %}
<div class="post">
    <p class="u-remove-margin-top u-remove-margin-bottom">
        {{ render_avatar(post.author) }}&nbsp;said:
        {% if post.author == current_user or current_user.is_admin %}
        <small class="u-pull-right">
            <a href="{{ url_for('posts.post_edit', slug=cause.slug, pk=post.id) }}">
                <span class="oi" data-glyph="pencil"></span>
                {{ _('Edit') }}
            </a>
        </small>
        {% endif %}
    </p>
    <article id="post-body-{{ post.id }}">
        <span class="u-pull-left">
            {% for image in post.images.all() %}
                <a data-target="modal-post-image-{{ post.id }}">
                    <img class="post-image-thumbnail" src="{{ image.image_path|resize('128x128', fill='True') }}" />
                </a>
                <div id="modal-post-image-{{ post.id }}" class="modal">
                    <div style="width:initial; display:inline-block">
                        <a class="button-modal-close u-pull-right">
                            <img src="{{ url_for('static', filename='open-iconic/png/x-2x.png') }}" alt="X" style="margin-bottom:0.5em" />
                        </a>
                        <img class="u-cf" src="{{ image.image_url }}" />
                    </div>
                </div>
            {% endfor %}
        </span>
        {{ post.body | markdown | striptags | truncate(280, True) }} 
        <br class="u-cf">
    </article>
    <small>
        {{ post.created_on.strftime('%b. %d, %Y') }}
        <span class="u-pull-right">
            <a href="{{ url_for('posts.post_detail', slug=cause.slug, pk=post.id) }}">
                <span class="oi" data-glyph="comment-square"></span>
                {{ _('%(count)s comments', count=post.comments.count()) }}
            </a>
        </span>
    </small>
</div>
{% endmacro %}

{% macro render_post_list(cause) %}
{% if cause.posts %}
    {% for post in cause.posts.all() %}
        {% if loop.first  %}<div class="row">{% endif %}
        {{ render_post(cause, post) }}
        {% if loop.index is divisibleby(3) and not loop.last %}</div><div class="row">{% endif %}
        {% if loop.last %}</div>{% endif %}
    {% endfor %}
{% else %}
    <div class="four columns offset-by-four">
        <p>
            <strong>
                {{ _('No posts!') }}
            </strong>
            <a class="button u-add-margin-left"
                href="{{ url_for('posts.post_add', slug=cause.slug) }}">
                {{ _('Start the conversation') }}
            </a>
        </p>
    </div>
{% endif %}
{% endmacro %}
