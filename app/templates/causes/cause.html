{% extends "base.html" %}
{% set active_page = "dashboard" %}

{% block title %}{{ cause.title }} - {{ super() }}{% endblock %}

{% block meta %}
{{ super() }}
<meta property="og:title" content="{{ cause.title }} - Solid">
<meta property="og:type" content="article">
<meta property="og:url" content="{{ url_for('.cause_detail', slug=cause.slug, _external=True) }}">
<meta property="og:description" content="{{ cause.intro }}">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="{{ cause.title }} - Solid">
<meta name="twitter:text:description" content="{{ cause.intro }}">

{% if cause.image -%}
<meta property="og:image" content="{{ url_for('static', filename=cause.image, _external=True) }}">
<meta name="twitter:image" content="{{ url_for('static', filename=cause.image, _external=True) }}">
{% endif -%}    
{% endblock meta %}

{% block styles %}
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='bxslider-4/dist/jquery.bxslider.min.css') }}">
<style>
.hero,
.glass::before {
    {% if cause.image %}
    background: url({{ url_for('static', filename=cause.image) }}) no-repeat fixed center 65px;
    {% endif %}
}
</style>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/modal.js') }}"></script>
<script src="{{ url_for('static', filename='jquery.lazy/jquery.lazy.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/conversation.js') }}"></script>
<script src="{{ url_for('static', filename='bxslider-4/dist/jquery.bxslider.min.js') }}"></script>
<script>
    $(document).ready(function() {
        $('.actions-slider').bxSlider({
            responsive: true,
            slideWidth: 345,
            minSlides: 1,
            maxSlides: 3,
            slideMargin: 32
        });
        $('#stand-with-us').click(function() {
            ga('send', {
                hitType: 'event',
                eventCategory: 'cause',
                eventAction: 'click support',
                eventLabel: '{{ cause.slug }}'
            });
        });
        $('a.support-action').click(function(e) {
            var action_name = $(e.target).parents('.support-action').find('h4').text();
            ga('send', {
                hitType: 'event',
                eventCategory: 'action',
                eventAction: 'popup',
                eventLabel: action_name
            });
        });
        $('a.support[rel=external]').click(function(e) {
            window.location.href = $(e.target).data('supportHref');
        });
        $('.button-modal-close').click(function(e) {
            var action_name = $(e.target).parents('.modal').find('h3').text();
            ga('send', {
                hitType: 'event',
                eventCategory: 'action',
                eventAction: 'popup close',
                eventLabel: action_name
            });
            e.preventDefault();
            history.pushState("", document.title, window.location.pathname);
        });
        $('a.support').click(function(e) {
            var action_name = $(e.target).parents('.modal').find('h3').text();
            ga('send', {
                hitType: 'event',
                eventCategory: 'action',
                eventAction: 'support',
                eventLabel: action_name
            });
        });
        {% if cause_support %}
            ga('send', {
                hitType: 'event',
                eventCategory: 'cause',
                eventAction: 'commit support',
                eventLabel: '{{ cause_support }}'
            });
        {% endif %}
    });
</script>
{% endblock %}

{% block content %}
{% from "helpers/causes.html" import render_log with context %}
{% from "helpers/modals.html" import render_modal %}
{% from "helpers/users.html" import render_avatar %}
{% from "helpers/actions.html" import render_action_list with context %}
{% from "helpers/posts.html" import render_post_list %}
<div class="section hero lazy" {% if cause.image %}data-src="{{ url_for('static', filename=cause.image) }}"{% endif %}>
    <div class="full-width-container">
        <div class="row">
            <div class="twelve columns">
                <div class="glass">
                    <h4 class="hero-heading">
                        {{ cause.title|truncate(40) }}
                    </h4>
                    {% if cause.intro %}
                    <p class="hero-content">
                        {{ cause.intro|truncate(180) }}
                    </p>
                    {% endif %}
                    {% if supporter %}
                    <h5 class="u-add-margin-left u-add-margin-right">&#10004;&nbsp;{{ _('You are supporting this cause') }}</h5>
                    {% else %}
                        <a id="stand-with-us" 
                           class="button button-primary hero-button" 
                           href="{{ url_for('causes.cause_support', slug=cause.slug) }}">
                           {{ _('Stand with us!') }}
                       </a>
                       <span class="hero-aside">
                           {{ _("Join this cause's community, and stay updated on actions") }}
                       </span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
<div class="full-width-container u-add-margin-top">
    <div class="row">
        <div class="nine columns">
            <div class="row">

                <div class="one-third column">
                    <a class="button button-modal u-full-width u-add-margin-top"
                        data-target="modal-share">
                        {{ _('Share') }}
                    </a>
                    <h4 class="u-add-margin-top u-remove-margin-bottom">
                        {{ _('Creators') }}
                    </h4>
                    {% for u in cause.creators.all()[-10:] | reverse %}
                        {{ render_avatar(u) }}
                        {% if loop.last and loop.index == 10 %}
                            <small class="see-all"><a href="{{ url_for('causes.view_cause_creators', slug=cause.slug) }}">See&nbsp;all&nbsp;{{ cause.creators.all() | length }}</a></small>
                        {% endif %}
                    {% endfor %}
<h4 class="u-add-margin-top u-remove-margin-bottom">
                        {{ _('%(count)s supporters', count=cause.supporters.all() | length) }}
                    </h4>
                    {% for u in cause.supporters.all()[-10:] | reverse %}
                        {{ render_avatar(u) }}
                        {% if loop.last and loop.index == 10 %}
                            <small class="see-all"><a href="{{ url_for('causes.view_cause_supporters', slug=cause.slug) }}">See&nbsp;all&nbsp;{{ cause.supporters.all() | length }}</a></small>
                        {% endif %}
                    {% endfor %}
                    <h4 class="u-add-margin-top u-remove-margin-bottom">
                        {{ _('Actions taken') }}
                    </h4>
                    <h1>{{ cause.count_action_supports }}</h1>
                </div>
                <div id="modal-share" class="modal">
                    <div style="width:300px;">
                        <h3 class="u-pull-left">
                            {{ _('Share this cause') }}
                        </h3>
                        <a href="#" class="button-modal-close u-pull-right">
                            <img src="/static/open-iconic/png/x-2x.png" alt="X" />
                        </a>
                        <p class="u-cf u-full-width u-text-center">
                            <a href="https://www.facebook.com/sharer/sharer.php?u={{ 
                                     url_for('causes.cause_detail', slug=cause.slug,
                                             _external=True) | urlencode
                                     }}" 
                               target="_blank"
                               class="u-add-margin-right"><img class="icon-social" src="{{ url_for('static', filename='icons/facebook-square.png') }}"></a>
                            <a href="https://twitter.com/home?status={{
                                     url_for('causes.cause_detail', slug=cause.slug,
                                             _external=True) | urlencode
                                     }}"
                               target="_blank"
                               class="u-add-margin-right"><img class="icon-social" src="{{ url_for('static', filename='icons/twitter.png') }}"></a>
                            <a href="https://plus.google.com/share?url={{
                                     url_for('causes.cause_detail', slug=cause.slug,
                                             _external=True) | urlencode
                                     }}" 
                               target="_blank"><img class="icon-social" src="{{ url_for('static', filename='icons/googleplus-square.png') }}"></a>
                        </p>
                    </div>
                </div>

                <div class="two-thirds column">
                    <h3>{{ cause.story_heading }}</h3>
                    {{ cause.story_content|markdown }}
                </div>

            </div>
            <hr>
            <div class="row">
                <div class="eight columns">
                    <h3 id="actions">
                        {{ _('Take action to win') }}
                        <span>
                            {{ _('%(count)s available', count=actions.count()) }}
                            &nbsp;|&nbsp;
                            {{ _('%(count)s taken', count=cause.count_action_supports) }}
                        </span>
                    </h3>
                </div>
                {% if current_user in cause.creators.all() or current_user.is_admin %}
                <div class="four columns">
                    <a class="button u-full-width" href="{{ url_for('.action_add', slug=cause.slug) }}">
                        <span class="oi" data-glyph="plus" title="Add new action" aria-hidden="true"></span>
                        <span>&nbsp;{{ _('new action') }}</span>
                    </a>
                </div>
                {% endif %}
            </div>
            
            {{ render_action_list(actions.all()) }}

            <hr>
            <div class="row">
                <div class="eight columns">
                    <h3>{{ _('Conversation') }}</h3>
                </div>
                {% if current_user in cause.supporters.all() or current_user.is_admin %}
                <div class="four columns">
                    <a class="button u-full-width" href="{{ url_for('posts.post_add', slug=cause.slug) }}">
                        <span class="oi" data-glyph="plus" title="Add new post" aria-hidden="true"></span>
                        <span>&nbsp;{{ _('new post') }}</span>
                    </a>
                </div>
                {% endif %}
            </div>
            {{ render_post_list(cause) }}
        </div>

        <div class="three columns">
            <div class="row">
                <div class="twelve columns">
                    {{ render_log(log) }}  
                </div>
            </div>
        </div>

    </div>

</div>
{% endblock %}
