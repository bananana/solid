{% extends "base.html" %}
{% set active_page = "dashboard" %}

{% block title %}{{ cause.title }} - {{ super() }}{% endblock %}

{% block meta %}
{{ super() }}
<meta property="og:title" content="{{ cause.title }} - Solid">
<meta property="og:type" content="article">
<meta property="og:url" content="{{ url_for('.cause_detail', slug=cause.slug, _external=True) }}">
<meta property="og:description" content="{{ cause.intro }}">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="{{ cause.title }} - Solid">
<meta name="twitter:text:description" content="{{ cause.intro }}">

{% if cause.image -%}
<meta property="og:image" content="{{ cause.image_url }}">
<meta name="twitter:image" content="{{ cause.image_url }}">
{% endif -%}
{% endblock meta %}

{% block styles %}
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='bxslider-4/dist/jquery.bxslider.min.css') }}">
<style>
.hero,
.glass::before {
    {% if cause.image %}
    background: url({{ cause.image_url }}) no-repeat fixed 0 65px;
    {% endif %}
}
</style>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/modal.js') }}"></script>
<script src="{{ url_for('static', filename='jQuery-form/dist/jquery.form.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/update_bar.js') }}"></script>
<script src="{{ url_for('static', filename='Readmore.js/readmore.min.js') }}"></script>
<script src="{{ url_for('static', filename='jquery.lazy/jquery.lazy.min.js') }}"></script>
<script src="{{ url_for('static', filename='bxslider-4/dist/jquery.bxslider.min.js') }}"></script>
<script src="{{ url_for('static', filename='autosize/dist/autosize.min.js') }}"></script>
{% if current_user.is_authenticated %}
<script src="{{ url_for('static', filename='js/post_image_preview.js') }}"></script>
{% endif %}
<script>
    $(document).ready(function() {
        $('.actions-slider').bxSlider({
            responsive: true,
            slideWidth: 345,
            minSlides: 1,
            maxSlides: 4,
            slideMargin: 32,
            infiniteLoop: false
        });

        $('#follow').click(function() {
            ga('send', {
                hitType: 'event',
                eventCategory: 'cause',
                eventAction: 'click follow',
                eventLabel: '{{ cause.slug }}'
            });
        });

        $('.button-modal-close').click(function(e) {
            var action_name = $(e.target).parents('.modal').find('h3').text();
            ga('send', {
                hitType: 'event',
                eventCategory: 'action',
                eventAction: 'popup close',
                eventLabel: action_name
            });
            e.preventDefault();
            history.pushState("", document.title, window.location.pathname);
        });

        var breakpoint = {};
        breakpoint.refreshValue = function () {
          this.value = window.getComputedStyle(document.querySelector('body'), ':before').getPropertyValue('content').replace(/\"/g, '');
        };

        function read_more() {
          if (breakpoint.value == 'smartphone'){
            $('.read_more').readmore({collapsedHeight: 300});
          }
        }

        $(window).resize(function () {
          breakpoint.refreshValue();
          read_more();
        }).resize();
        
        {% if cause_support %}
            ga('send', {
                hitType: 'event',
                eventCategory: 'cause',
                eventAction: 'commit support',
                eventLabel: '{{ cause_support }}'
            });
        {% endif %}

        autosize(document.getElementById('body'));
    });
</script>
{% endblock %}

{% block content %}
{% from "helpers/logs.html" import render_log with context %}
{% from "helpers/modals.html" import render_modal %}
{% from "helpers/users.html" import render_avatar %}
{% from "helpers/actions.html" import render_action_list with context %}
<div class="section hero lazy" {% if cause.image %}data-src="{{ cause.image_url }}"{% endif %}>
    <div class="full-width-container">
        <div class="row">
            <div class="twelve columns">
                <div class="glass">
                    <h4 class="hero-heading">
                        {{ cause.title|truncate(40) }}
                    </h4>
                    {% if cause.intro %}
                    <p class="hero-content">
                        {{ cause.intro|truncate(180) }}
                    </p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
<div class="full-width-container u-add-margin-top">
    <div id="actions" class="row">
        <div class="eight columns">
            <h3 id="actions">
                {{ _('Take action to win') }}
                <span>
                    {{ _('%(count)s available', count=actions.count()) }}
                    <!--
                    &nbsp;|&nbsp;
                    {{ _('%(count)s taken', count=cause.count_action_supports) }}
                    -->
                </span>
            </h3>
        </div>
        {% if current_user in cause.creators.all() or current_user.is_admin %}
        <div class="four columns">
            <a class="button u-pull-right" href="{{ url_for('.action_add_edit', slug=cause.slug) }}">
                <span class="oi" data-glyph="plus" aria-hidden="true"
                    title="{{ _('Add new action') }}"></span>
                <span>&nbsp;{{ _('new action') }}</span>
            </a>
        </div>
        {% endif %}
    </div>
    <div id="log" class="row">
        <div class="twelve columns">
            {{ render_action_list(actions.all()) }}
        </div>
    </div>
    <div class="row">
        <div class="three columns">
            {% if supporter %}
            <h5>&#10004;&nbsp;{{ _('You are supporting this cause') }}</h5>
            <a class="button button-modal u-add-margin-top u-full-width"
               data-target="modal-share">
                {{ _('Share') }}
            </a>
            {% else %}
            <a id="follow"
               class="button button-primary"
               href="{{ url_for('causes.cause_support', slug=cause.slug) }}"
               title="{{ _("Stay updated on actions") }}">
               {{ _('Follow') }}
            </a>
            <a class="button button-modal u-add-margin-top"
                data-target="modal-share">
                {{ _('Share') }}
            </a>
            {% endif %}
            <h4 class="u-add-margin-top">
                {{ _('Cause creators') }}
            </h4>
            {% for u in cause.creators.all()[-10:] | reverse %}
                {{ render_avatar(u) }}
                {% if loop.last and loop.index == 10 %}
                    <small class="see-all">
                        <a href="{{ url_for('causes.view_cause_creators', slug=cause.slug) }}">
                            See&nbsp;all&nbsp;{{ cause.creators.all() | length }}
                        </a>
                    </small>
                {% endif %}
            {% endfor %}
            <h4 class="u-add-margin-top">
                {{ _('%(count)s supporters', count=cause.supporters.all() | length) }}
            </h4>
            {% for u in cause.supporters.all()[-10:] | reverse %}
                {{ render_avatar(u) }}
                {% if loop.last and loop.index == 10 %}
                    <small class="see-all">
                        <a href="{{ url_for('causes.view_cause_supporters', slug=cause.slug) }}">
                            See&nbsp;all&nbsp;{{ cause.supporters.all() | length }}
                        </a>
                    </small>
                {% endif %}
            {% endfor %}
            <h4 class="u-add-margin-top u-remove-margin-bottom">
                {{ _('Actions taken') }}
            </h4>
            <h1>{{ cause.count_action_supports }}</h1>
        </div>

        <div id="modal-share" class="modal">
            <div style="width:300px;">
                <h3 class="u-pull-left">
                    {{ _('Share this cause') }}
                </h3>
                <a href="#" class="button-modal-close u-pull-right">
                    <img src="/static/open-iconic/png/x-2x.png" alt="X" />
                </a>
                <p class="u-cf u-full-width u-text-center">
                    <a href="https://www.facebook.com/sharer/sharer.php?u={{
                             url_for('causes.cause_detail', slug=cause.slug,
                                     _external=True) | urlencode
                             }}"
                       target="_blank"
                       class="u-add-margin-right">
                        <img class="icon-social" src="{{ url_for('static', filename='icons/facebook-square.png') }}">
                    </a>
                    <a href="https://twitter.com/home?status={{
                             url_for('causes.cause_detail', slug=cause.slug,
                                     _external=True) | urlencode
                             }}"
                       target="_blank"
                       class="u-add-margin-right">
                        <img class="icon-social" src="{{ url_for('static', filename='icons/twitter.png') }}">
                    </a>
                    <a href="https://plus.google.com/share?url={{
                             url_for('causes.cause_detail', slug=cause.slug,
                                     _external=True) | urlencode
                             }}"
                       target="_blank">
                        <img class="icon-social" src="{{ url_for('static', filename='icons/googleplus-square.png') }}">
                    </a>
                </p>
            </div>
        </div>

        <div class="six columns">
            {% if current_user.is_authenticated %}
                {% include 'posts/post_form.html' %}
            {% else %}
                <small class="posting-unauthorized u-text-center">
                    Only supporters can post messages. 
                    Please <a href="{{ url_for('users.login') }}">log in</a>.
                </small>
            {% endif %}
            {{ render_log(log.items) }}
            <div class="u-full-width">
                {% if log.has_next %}
                    <a class="u-pull-left" 
                       href="{{ url_for('.cause_detail', slug=cause.slug, page=log.next_num) }}#actions">
                        <span class="oi" data-glyph="caret-left"></span><span style="vertical-align:2px;">Older</span>
                    </a>
                {% endif %}
                {% if log.has_prev %}
                    <a class="u-pull-right" i
                       href="{{ url_for('.cause_detail', slug=cause.slug, page=log.prev_num) }}#actions">
                        <span style="vertical-align:2px;">Newer</span><span class="oi" data-glyph="caret-right"></span>
                    </a>
                {% endif %}
            </div>
        </div>

        <div class="three columns">
            {% if cause.story_heading %}
            <h3>{{ cause.story_heading }}</h3>
            {% endif %}
            <article class="read_more">
                {{ cause.story_content|markdown }}
            </article>
        </div>
    </div>
</div>
{% endblock %}
