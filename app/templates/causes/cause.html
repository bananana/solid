{% extends "base.html" %}
{% set active_page = "dashboard" %}

{% block title %}{{ cause.title }} - {{ super() }}{% endblock %}

{% block styles %}
<style>
.hero,
.glass::before {
    {% if cause.image %}
    background: url({{ url_for('static', filename=cause.image) }}) no-repeat fixed center 65px;
    {% endif %}
}
</style>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/modal.js') }}"></script>
<script src="{{ url_for('static', filename='jquery.lazy/jquery.lazy.min.js') }}"></script>
<script>
    $(document).ready(function() {
        $('#stand-with-us').click(function() {
            ga('send', {
                hitType: 'event',
                eventCategory: 'Causes',
                eventAction: 'support',
                eventLabel: 'cause'
            });
        });
        $('a.support').click(function() {
            ga('send', {
                hitType: 'event',
                eventCategory: 'Causes',
                eventAction: 'support',
                eventLabel: 'action'
            });
        });
        $('a.support[rel=external]').click(function(e) {
            window.location.href = $(e.target).data('supportHref');
        });
    });
</script>
{% endblock %}

{% block content %}
{% from "helpers/modals.html" import render_modal %}
{% from "helpers/users.html" import render_avatar %}
{% from "helpers/posts.html" import render_post_list %}
<div class="section hero lazy" data-src="{{ url_for('static', filename=cause.image) }}">
    <div class="full-width-container">
        <div class="row">
            <div class="twelve columns">
                <div class="glass">
                    <h4 class="hero-heading">
                        {{ cause.title }}
                    </h4>
                    {% if cause.intro %}
                    <p class="hero-content">
                        {{ cause.intro }}
                    </p>
                    {% endif %}
                    {% if supporter %}
                    <h5 class="u-add-margin-left u-add-margin-right">&#10004;&nbsp;{{ _('You are supporting this cause') }}</h5>
                    {% else %}
                        <a id="stand-with-us" 
                           class="button button-primary hero-button" 
                           href="{{ url_for('causes.cause_support', slug=cause.slug) }}">
                           {{ _('Stand with us!') }}
                       </a>
                       <span>
                           {{ _("Join this cause's community, and stay updated on actions") }}
                       </span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
<div class="full-width-container u-add-margin-top">
    <div class="row">
        <div class="nine columns">
            <h3>{{ cause.story_heading }}</h3>
            {{ cause.story_content|markdown }}
        </div>
        <div class="three columns">
            <a class="button button-modal u-full-width u-add-margin-top"
                data-target="modal-share">
                {{ _('Share') }}
            </a>
            <h4 class="u-add-margin-top">
                {{ _('Creators') }}:
            </h4>
            {% for u in cause.creators.all() %}
                {{ render_avatar(u) }}
            {% endfor %}
            <h4 class="u-add-margin-top">
                {{ _('%(count)s supporters', count=cause.supporters.count()) }}:
            </h4>
            {% for u in cause.supporters.all() %}
                {{ render_avatar(u) }}
            {% endfor %}
        </div>
        <div id="modal-share" class="modal">
            <div style="width:300px;">
                <h3 class="u-pull-left">
                    {{ _('Share this cause') }}
                </h3>
                <a href="#" class="button-modal-close u-pull-right">
                    <img src="/static/open-iconic/png/x-2x.png" alt="X" />
                </a>
                <p class="u-cf u-full-width u-text-center">
                    <a href="https://www.facebook.com/sharer/sharer.php?u={{ 
                             url_for('causes.cause_detail', slug=cause.slug,
                                     _external=True) | urlencode
                             }}" 
                       target="_blank"
                       class="u-add-margin-right"><img class="icon-social" src="{{ url_for('static', filename='icons/facebook-square.png') }}"></a>
                    <a href="https://twitter.com/home?status={{
                             url_for('causes.cause_detail', slug=cause.slug,
                                     _external=True) | urlencode
                             }}"
                       target="_blank"
                       class="u-add-margin-right"><img class="icon-social" src="{{ url_for('static', filename='icons/twitter.png') }}"></a>
                    <a href="https://plus.google.com/share?url={{
                             url_for('causes.cause_detail', slug=cause.slug,
                                     _external=True) | urlencode
                             }}" 
                       target="_blank"><img class="icon-social" src="{{ url_for('static', filename='icons/googleplus-square.png') }}"></a>
                </p>
            </div>
        </div>
    </div>
    <hr>
    <div class="row">
        <div class="nine columns actions">
            <h3 id="actions">
                {{ _('Take action to win') }}
                <span>{{ _('(%(count)s current)', count=cause.actions.count()) }}</span>
            </h3>
            <div class="row">
                {% for action in cause.actions.all()[0:4] %}
                    <a class="four columns support-action" 
                       data-target="modal-action-{{ action.id }}">
                        <h4>{{ action.title }}</h4>
                        <p>{{ action.summary }}</p>
                        <h6 class="u-remove-margin-bottom">
                            {{ _('Supporters: %(count)s', count=action.supporters.count()) }}
                        </h6>
                        {% if action.expiration %}
                            <h6>Expires: {{ action.expiration.strftime('%b. %d, %Y') }}</h6>
                        {% endif %}
                    </a>
                    <div id="modal-action-{{ action.id }}" class="modal">
                        <div>
                            <h3 class="u-pull-left u-remove-margin-bottom">{{ action.title }}</h3>
                            <a href="#" class="button-modal-close u-pull-right">
                                <img src="/static/open-iconic/png/x-2x.png" alt="X" />
                            </a>
                            <p class="u-cf">
                                {{ action.description|markdown }}
                            </p>
                            {% if current_user not in action.supporters.all() %}
                            <p class="u-remove-margin-bottom u-pull-right">
                                {% if action.link %}
                                <a class="button button-primary support" rel="external"  target="_blank"
                                    data-support-href="{{ url_for('causes.action_support', slug=cause.slug,
                                    pk=action.id) }}"
                                    href="{{ action.link }}">{{ _('Support!') }}</a>
                                {% else %}
                                <a class="button button-primary" href="{{ url_for('causes.action_support', slug=cause.slug,
                                    pk=action.id) }}">{{ _('Support!') }}</a>
                                {% endif %}
                            </p>
                            {% endif %}
                            {% if current_user in cause.creators.all() or current_user.is_admin %}
                            <p>
                                <a class="button primary u-pull-right u-add-margin-right" 
                                    href="{{ url_for('causes.action_edit', slug=cause.slug,
                                    pk=action.id) }}">Edit!</a>
                            </p>
                            {% endif %}
                            {% if action.supporters %}
                            <p class="u-remove-margin-bottom u-pull-left">
                                {% for supporter in action.supporters %}
                                    {{ render_avatar(supporter) }}
                                {% endfor %}
                            </p>
                            {% endif %}
                            <br class="u-cf">
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
    <hr>
    <div class="row">
        <div class="nine columns">
            <h3>{{ _('Conversation') }}</h3>
        </div>
        <div class="three columns">
            <a class="button u-full-width" href="/cause/{{ cause.slug }}/posts/add">
                {{ _('Add new post') }}
            </a>
        </div>
    </div>
    {{ render_post_list(cause) }}
</div>
{% endblock %}
